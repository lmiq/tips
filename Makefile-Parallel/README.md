# Using Makefile to run trivially parallel jobs

The `Makefile` in this folder exemplifies how to use the `make` functionality to run trivially parallelizable jobs. 

The `simulation.jl` file contains a simple Julia script that takes some seconds to finish and runs possibly in parallel, to emulate a simulation. This "simulation" can be run with

```
julia -t4 simulation.jl > simulation.log
```

where `4` is the number of processes (threads) that we want the simulation to use. 

The Makefile content is:

## Set the number of threads per simulation:
```
# Number of cores per simulation
NP=4
```

## List of simulations to be run, separated by spaces:
```
#
# Simulations
#
all: sim1_production sim2_production 
```

## First simulation

The simulation has two steps, an equilibration and a production step. The production step is indicated first, but it has a dependency, which is the `equilibration1.log` file. Only when this file is available and the corresponding process is finished the `sim1_production` step will run. 

The second instruction explains how to generate the `equilibration1.log` file, and this one has no dependencies. 
```
#
# First simulation
#
sim1_production : equilibration1.log
	julia -t$(NP) simulation.jl > production1.log

equilibration1.log :  
	julia -t$(NP) simulation.jl > equilibration1.log
```

## Second simulation

The same procedure goes for the second simulation:
```
#
# Second simulation
#
sim2_production : equilibration2.log
	julia -t$(NP) simulation.jl > production2.log

equilibration2.log :  
	julia -t$(NP) simulation.jl > equilibration2.log
```

# Running

The two simulations are, therefore, independent, and can be generated by a sequence of steps which is defined by the dependency tree of their output files. The number of independent sequences that `make` will run is defined by the `-jN` input parameter. 

For example, to run 2 independent simulations (each one using 4 threads, as defined by the `NP` parameter inside the `Makefile`) we do:

```
make -j2 
```

The following output will be produced:

```
% make -j 2
julia -t4 simulation.jl > equilibration1.log
julia -t4 simulation.jl > equilibration2.log
julia -t4 simulation.jl > production1.log
julia -t4 simulation.jl > production2.log
```

One can follow the CPU use with `top`, to verity that two `julia` processes using 4 threads each are running:

```
MiB Mem :  15871,2 total,   5804,7 free,   3398,3 used,   6668,2 buff/c
MiB Swap:   2048,0 total,   1676,6 free,    371,4 used.  11977,5 avail 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ 
 247009 leandro   20   0 1905944 288600  81876 R 371,8   1,8   0:11.19 
 247010 leandro   20   0 1906092 225352  82056 R 360,5   1,4   0:10.85 
    237 root     -51   0       0      0      0 D   5,0   0,0  26:39.41
```

## To clean all the output files, use:

```
make clean
```

being the instruction defined by:

```
#
# clean
#
clean : 
	rm -rf *.log
```


